name: Build Native Installers

on:
  push:
    branches: [ main, master, develop, vijay/modernize-project ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            installer-type: deb
          - os: windows-latest
            platform: windows
            installer-type: msi
          - os: macos-latest
            platform: macos
            installer-type: dmg
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      # Linux-specific: Install jpackage prerequisites
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot binutils rpm
      
      # Make gradlew executable on Unix-like systems
      - name: Make gradlew executable
        if: runner.os != 'Windows'
        run: chmod +x ./gradlew
      
      # Build the project first
      - name: Build project
        run: ./gradlew clean build -x test
        shell: bash
      
      # Run tests
      - name: Run tests
        run: ./gradlew test
        shell: bash
      
      # Create jpackage app image (platform-agnostic runtime image)
      - name: Create jpackage app image
        run: ./gradlew jpackageImage
        shell: bash
      
      # Create platform-specific installer
      - name: Create installer (${{ matrix.installer-type }})
        run: ./gradlew jpackage -PinstallerType=${{ matrix.installer-type }}
        shell: bash
        continue-on-error: true
      
      # Find and list generated artifacts
      - name: List build outputs
        run: |
          echo "=== Build output directory contents ==="
          ls -lah build/ || true
          echo ""
          echo "=== jpackage directory contents ==="
          ls -lah build/jpackage/ || true
        shell: bash
      
      # Upload the app image
      - name: Upload app image
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: filebot-app-image-${{ matrix.platform }}
          path: |
            build/jpackage/filebot/
            build/jpackage/FileBot.app/
          retention-days: 30
          if-no-files-found: warn
      
      # Upload installers - Linux (deb/rpm)
      - name: Upload Linux installer
        uses: actions/upload-artifact@v4
        if: runner.os == 'Linux'
        with:
          name: filebot-installer-${{ matrix.platform }}
          path: |
            build/jpackage/*.deb
            build/jpackage/*.rpm
          retention-days: 30
          if-no-files-found: warn
      
      # Upload installers - Windows (msi/exe)
      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        if: runner.os == 'Windows'
        with:
          name: filebot-installer-${{ matrix.platform }}
          path: |
            build/jpackage/*.msi
            build/jpackage/*.exe
          retention-days: 30
          if-no-files-found: warn
      
      # Upload installers - macOS (dmg/pkg)
      - name: Upload macOS installer
        uses: actions/upload-artifact@v4
        if: runner.os == 'macOS'
        with:
          name: filebot-installer-${{ matrix.platform }}
          path: |
            build/jpackage/*.dmg
            build/jpackage/*.pkg
          retention-days: 30
          if-no-files-found: warn
      
      # Upload test results if they exist
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.platform }}
          path: build/test-results/
          retention-days: 7
          if-no-files-found: ignore

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Linux    | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Windows  | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| macOS    | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts are available in the Actions tab above." >> $GITHUB_STEP_SUMMARY

